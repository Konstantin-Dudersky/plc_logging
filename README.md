# plc_logging

Логгирование сообщений от ПЛК.

[TOC]

Предусмотрены уровни логгирования:

| Уровень  | Численное значение | Комментарий               |
| -------- | ------------------ | ------------------------- |
| NOTSET   | 0                  | Логгируются все сообщения |
| DEBUG    | 10                 |                           |
| INFO     | 20                 |                           |
| WARNING  | 30                 |                           |
| ERROR    | 40                 |                           |
| CRITICAL | 50                 |                           |
| DISABLE  | 100                | Ничего не логгируется     |

Уровень логгирования задается в двух местах - глобально и в каждом FC/FB, в которых создаются сообщения. Чтобы сообщение попало в лог, необходимо, чтобы его уровень был не ниже обоих заданных уровней. Например

| Глобальный уровень | Уровень в блоке | Сообщение | Результат |
| ------------------ | --------------- | --------- | --------- |
| DEBUG              | DEBUG           | DEBUG     | в лог     |
| DEBUG              | DEBUG           | INFO      | в лог     |
| DEBUG              | INFO            | DEBUG     | игнор     |
| INFO               | DEBUG           | DEBUG     | игнор     |

Чтобы заблокировать все сообщения в ПЛК - установить глобальный уровень DISABLE.

## Настройка в контроллере

### Siemens

#### FB LoggerFB

Основной FB - LoggerFb, и связанный с ним блок данных logger. Блок нужно вызывать в OB1. Пример вызова:

```pascal
"logger"(global_logger_level := "LoggerLevels".NOTSET,
         ip_1 := 10,
         ip_2 := 101,
         ip_3 := 50,
         ip_4 := 17,
         port_number := 8000,
         interface_id := "Local~PROFINET_interface_1",
         id := 2
);
```

- ip и port - адрес и порт ПК, на котором запущен скрипт python.
- interface_id - идентификатор интерфейса, через который ПЛК посылает сообщения
- global_logger_level - глобальный уровень логгирования.

Настройки блока считываются при первом запуске. Если необходимо поменять настройки "на лету", нужно установить флаг init в True.

#### FC logger.config_in_block

В начале каждого блока, в котором логгируются сообщения, необходимо вызывать
функцию logger.config_in_block:

```pascal
"logger.config_in_block"(level := "LoggerLevels".DEBUG,
                         block_title := 'test_logger_block');
```

- block_title - строка, которая добавляется к каждому сообщению, для идентификации
  блока в логе сообщений
- level - минимальный уровень сообщений для логгирования.
  Например, если установлен уровень INFO, то логгируются сообщения уровнем
  INFO и выше. Также учитывается глобальный уровень логгирования

#### FC logger.LEVEL_NUM

Разные функции, в зависимости от уровня сообщения и кол-ва вспомогательных параметров. Например:

- logger.debug_0
- logger.debug_1
- logger.info_0
- logger.info_1
- и т.д.

LEVEL - уровень логгирования сообщения, NUM - кол-во вспомогательных параметров.

Пример вызова:

```pascal
#sp := 10;
#pv := 11;
"logger.debug_2"(msg := 'test debug message, SP: {0}, PV: {1}',
                 value_0 := REAL_TO_STRING(#sp),
                 value_1 := REAL_TO_STRING(#pv)
);
```

- msg - текст сообщения, тип STRING - т.е. поддерживаются только символы ASCII. В фигурных скобках {} можно указать место вставки доп. значений value. Нумерация начинается с 0.
- value - доп. значения в формате STRING.
